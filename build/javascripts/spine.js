(function(){var a;typeof exports!="undefined"?a=exports:a=this.Spine={},a.version="0.0.4";var b=a.$=this.jQuery||this.Zepto||function(){return arguments[0]},c=a.makeArray=function(a){return Array.prototype.slice.call(a,0)},d=a.isArray=function(a){return Object.prototype.toString.call(a)=="[object Array]"};typeof Array.prototype.indexOf=="undefined"&&(Array.prototype.indexOf=function(a){for(var b=0;b<this.length;b++)if(this[b]===a)return b;return-1});var e=a.Events={bind:function(a,b){var c=a.split(" "),d=this._callbacks||(this._callbacks={});for(var e=0;e<c.length;e++)(this._callbacks[c[e]]||(this._callbacks[c[e]]=[])).push(b);return this},trigger:function(){var a=c(arguments),b=a.shift(),d,e,f,g;if(!(e=this._callbacks))return!1;if(!(d=this._callbacks[b]))return!1;for(f=0,g=d.length;f<g;f++)if(d[f].apply(this,a)===!1)break;return!0},unbind:function(a,b){if(!a)return this._callbacks={},this;var c,d,e,f;if(!(d=this._callbacks))return this;if(!(c=this._callbacks[a]))return this;if(!b)return delete this._callbacks[a],this;for(e=0,f=c.length;e<f;e++)if(b===c[e]){c.splice(e,1);break}return this}},f=a.Log={trace:!0,logPrefix:"(App)",log:function(){if(!this.trace)return;if(typeof console=="undefined")return;var a=c(arguments);return this.logPrefix&&a.unshift(this.logPrefix),console.log.apply(console,a),this}};typeof Object.create!="function"&&(Object.create=function(a){function b(){}return b.prototype=a,new b});var g=["included","extended"],h=a.Class={inherited:function(){},created:function(){},prototype:{initialize:function(){},init:function(){}},create:function(a,b){var c=Object.create(this);return c.parent=this,c.prototype=c.fn=Object.create(this.prototype),a&&c.include(a),b&&c.extend(b),c.created(),this.inherited(c),c},init:function(){var a=Object.create(this.prototype);return a.parent=this,a.initialize.apply(a,arguments),a.init.apply(a,arguments),a},proxy:function(a){var b=this;return function(){return a.apply(b,arguments)}},proxyAll:function(){var a=c(arguments);for(var b=0;b<a.length;b++)this[a[b]]=this.proxy(this[a[b]])},include:function(a){for(var b in a)g.indexOf(b)==-1&&(this.fn[b]=a[b]);var c=a.included;return c&&c.apply(this),this},extend:function(a){for(var b in a)g.indexOf(b)==-1&&(this[b]=a[b]);var c=a.extended;return c&&c.apply(this),this}};h.prototype.proxy=h.proxy,h.prototype.proxyAll=h.proxyAll,h.instancet=h.init,h.sub=h.create,a.guid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=Math.random()*16|0,c=a=="x"?b:b&3|8;return c.toString(16)}).toUpperCase()};var i=a.Model=h.create();i.extend(e),i.extend({setup:function(a,b){var c=i.sub();return a&&(c.name=a),b&&(c.attributes=b),c},created:function(a){this.records={},this.attributes=this.attributes?c(this.attributes):[]},find:function(a){var b=this.records[a];if(!b)throw"Unknown record";return b.clone()},exists:function(a){try{return this.find(a)}catch(b){return!1}},refresh:function(b){b=this.fromJSON(b),this.records={};for(var c=0,d=b.length;c<d;c++){var e=b[c];e.newRecord=!1,e.id=e.id||a.guid(),this.records[e.id]=e}return this.trigger("refresh"),this},createAll:function(b){b=this.fromJSON(b);for(var c=0,d=b.length;c<d;c++){var e=b[c];e.newRecord=!1,e.id=e.id||a.guid(),this.records[e.id]=e}return this},select:function(a){var b=[];for(var c in this.records)a(this.records[c])&&b.push(this.records[c]);return this.cloneArray(b)},findByAttribute:function(a,b){for(var c in this.records)if(this.records[c][a]==b)return this.records[c].clone()},findAllByAttribute:function(a,b){return this.select(function(c){return c[a]==b})},each:function(a){for(var b in this.records)a(this.records[b])},all:function(){return this.cloneArray(this.recordsValues())},first:function(){var a=this.recordsValues()[0];return a&&a.clone()},last:function(){var a=this.recordsValues(),b=a[a.length-1];return b&&b.clone()},count:function(){return this.recordsValues().length},deleteAll:function(){for(var a in this.records)delete this.records[a]},destroyAll:function(){for(var a in this.records)this.records[a].destroy()},update:function(a,b){this.find(a).updateAttributes(b)},create:function(a){var b=this.init(a);return b.save()},destroy:function(a){this.find(a).destroy()},sync:function(a){this.bind("change",a)},fetch:function(a){typeof a=="function"?this.bind("fetch",a):this.trigger("fetch",a)},toJSON:function(){return this.recordsValues()},fromJSON:function(a){if(!a)return;typeof a=="string"&&(a=JSON.parse(a));if(d(a)){var b=[];for(var c=0;c<a.length;c++)b.push(this.init(a[c]));return b}return this.init(a)},recordsValues:function(){var a=[];for(var b in this.records)a.push(this.records[b]);return a},cloneArray:function(a){var b=[];for(var c=0;c<a.length;c++)b.push(a[c].clone());return b},logAll:function(){for(var a=0;a<this.all().length;a++){var b=this.all()[a];window.console&&console.log(b.toString())}}}),i.include({model:!0,newRecord:!0,init:function(a){a&&this.load(a),this.trigger("init",this)},isNew:function(){return this.newRecord},isValid:function(){return!this.validate()},validate:function(){},load:function(a){for(var b in a)this[b]=a[b]},attributes:function(){var a={};for(var b=0;b<this.parent.attributes.length;b++){var c=this.parent.attributes[b];a[c]=this[c]}return a.id=this.id,a},eql:function(a){return a&&a.id===this.id&&a.parent===this.parent},save:function(){var a=this.validate();return a?(this.trigger("error",this,a),!1):(this.trigger("beforeSave",this),this.newRecord?this.create():this.update(),this.trigger("save",this),this)},updateAttribute:function(a,b){return this[a]=b,this.save()},updateAttributes:function(a){return this.load(a),this.save()},destroy:function(){this.trigger("beforeDestroy",this),delete this.parent.records[this.id],this.destroyed=!0,this.trigger("destroy",this),this.trigger("change",this,"destroy")},dup:function(){var a=this.parent.init(this.attributes());return a.newRecord=this.newRecord,a},clone:function(){return Object.create(this)},reload:function(){if(this.newRecord)return this;var a=this.parent.find(this.id);return this.load(a.attributes()),a},toJSON:function(){return this.attributes()},exists:function(){return this.id&&this.id in this.parent.records},update:function(){this.trigger("beforeUpdate",this);var a=this.parent.records;a[this.id].load(this.attributes());var b=a[this.id].clone();this.trigger("update",b),this.trigger("change",b,"update")},create:function(){this.trigger("beforeCreate",this),this.id||(this.id=a.guid()),this.newRecord=!1;var b=this.parent.records;b[this.id]=this.dup();var c=b[this.id].clone();this.trigger("create",c),this.trigger("change",c,"create")},bind:function(a,b){return this.parent.bind(a,this.proxy(function(a){a&&this.eql(a)&&b.apply(this,arguments)}))},trigger:function(){return this.parent.trigger.apply(this.parent,arguments)}});var j=/^(\w+)\s*(.*)$/,k=a.Controller=h.create({tag:"div",initialize:function(a){this.options=a;for(var c in this.options)this[c]=this.options[c];this.el||(this.el=document.createElement(this.tag)),this.el=b(this.el),this.events||(this.events=this.parent.events),this.elements||(this.elements=this.parent.elements),this.events&&this.delegateEvents(),this.elements&&this.refreshElements(),this.proxied&&this.proxyAll.apply(this,this.proxied)},$:function(a){return b(a,this.el)},delegateEvents:function(){for(var a in this.events){var b=this.events[a],c=this.proxy(this[b]),d=a.match(j),e=d[1],f=d[2];f===""?this.el.bind(e,c):this.el.delegate(f,e,c)}},refreshElements:function(){for(var a in this.elements)this[this.elements[a]]=this.$(a)},delay:function(a,b){setTimeout(this.proxy(a),b||0)}});k.include(e),k.include(f),a.App=h.create(),a.App.extend(e),k.fn.App=a.App})();